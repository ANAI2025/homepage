<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bộ nhớ Kịch bản</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .item.active {
            background-color: #3b82f6; /* blue-500 */
        }
        .delete-btn {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .item:hover .delete-btn {
            visibility: visible;
            opacity: 1;
        }
         /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; } /* gray-800 */
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col p-8">
    
    <header class="flex justify-between items-center mb-6 flex-shrink-0">
                <h1 class="text-3xl font-bold">Bộ nhớ Kịch bản</h1>
    </header>

    <main class="bg-gray-800 p-6 rounded-lg w-full h-full flex flex-col shadow-2xl">
    <div class="flex space-x-6 flex-grow overflow-hidden" style="height:700px;min-height:700px;max-height:700px;">
            <!-- List Column -->
            <div style="width:340px;min-width:340px;max-width:340px;" class="border-r border-gray-700 pr-4 flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Danh sách Kịch bản</h3>
                    <div class="flex space-x-2">
                        <button id="new-item-btn" title="Tạo mục mới" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                        <button id="delete-all-btn" title="Xóa tất cả" class="bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-full transition duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="item-list" class="space-y-2 overflow-y-auto flex-grow pr-2" style="width:40px;min-width:40px;max-width:40px;">
                    <!-- Dynamic list of items -->
                </div>
            </div>
            <!-- Editor Column -->
            <div id="editor-panel" class="flex-1 hidden flex-col">
                <form id="item-form" class="space-y-4 flex flex-col flex-grow" style="height:100%;width:100%;">
                    <input type="hidden" id="item-id">
                    <div>
                        <label for="item-title" class="block text-sm font-medium text-gray-300">Tiêu đề</label>
                        <input type="text" id="item-title" placeholder="Nhập tiêu đề..." required class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="flex-grow flex flex-col" style="height:calc(100vh - 220px);">
                        <label for="item-content" class="block text-sm font-medium text-gray-300">Nội dung</label>
                        <textarea id="item-content" placeholder="Dán hoặc nhập nội dung..." required class="mt-1 block w-full min-h-[500px] max-h-[500px] bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500" style="resize:none;"></textarea>
                    </div>
                    <div class="flex justify-start space-x-3 pt-2 mt-4">
                        <button type="button" id="back-home-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M3 12l6-6m-6 6l6 6" />
                            </svg>
                            Trang chủ
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Lưu</button>
                        <button type="button" id="edit-item-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md">Chỉnh sửa</button>
                        <button type="button" id="copy-item-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Copy</button>
                        <button type="button" id="export-txt-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Xuất TXT</button>
                    </div>
                </form>
            </div>
             <div id="editor-placeholder" class="flex-1 flex items-center justify-center text-gray-500">
                <p>Chọn một kịch bản để xem hoặc tạo kịch bản mới.</p>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
         <div class="bg-gray-700 rounded-lg shadow-xl p-8 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Xác nhận xóa</h2>
            <p class="text-gray-300 mb-6">Bạn có chắc chắn muốn xóa kịch bản này không?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md">Hủy</button>
                <button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md">Xóa</button>
            </div>
        </div>
    </div>

    <script>
            // Nút quay lại trang chủ
            const backHomeBtn = document.getElementById('back-home-btn');
            backHomeBtn.addEventListener('click', () => {
                window.location.href = '/index.html';
            });
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const newItemBtn = document.getElementById('new-item-btn');
            const itemList = document.getElementById('item-list');
            const editorPanel = document.getElementById('editor-panel');
            const editorPlaceholder = document.getElementById('editor-placeholder');
            const itemForm = document.getElementById('item-form');
            const itemIdInput = document.getElementById('item-id');
            const itemTitleInput = document.getElementById('item-title');
            const itemContentInput = document.getElementById('item-content');
            // copyItemBtn sẽ được khai báo ở dưới khi thêm event
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            // --- Data ---
            let scripts = JSON.parse(localStorage.getItem('memory_mainScripts')) || [];
            let itemIdToDelete = null;

            // --- Functions ---
            const saveData = () => {
                localStorage.setItem('memory_mainScripts', JSON.stringify(scripts));
            };

            const renderItemList = () => {
                itemList.innerHTML = '';
                const currentId = itemIdInput.value;
                scripts.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `w-full text-left p-3 rounded-md transition-colors item cursor-pointer ${item.id == currentId ? 'active' : 'hover:bg-gray-700'}`;
                    div.dataset.id = item.id;
                    div.innerHTML = `
                        <span class="truncate pointer-events-none">${item.title}</span>
                        <button class="delete-btn text-gray-400 hover:text-red-500 p-1 rounded-full" data-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    itemList.appendChild(div);
                });
            };

            const showEditor = (show) => {
                editorPanel.classList.toggle('hidden', !show);
                editorPlaceholder.classList.toggle('hidden', show);
            };

            const clearEditorForm = () => {
                itemForm.reset();
                itemIdInput.value = '';
                renderItemList();
            };
            
            const loadItemIntoForm = (id) => {
                const item = scripts.find(p => p.id == id);
                if (item) {
                    itemIdInput.value = item.id;
                    itemTitleInput.value = item.title;
                    itemContentInput.value = item.content;
                    showEditor(true);
                }
                renderItemList();
            };

            const openDeleteModal = (id) => {
                itemIdToDelete = id;
                deleteConfirmModal.classList.remove('hidden');
            };

            const closeDeleteModal = () => {
                itemIdToDelete = null;
                deleteConfirmModal.classList.add('hidden');
            };

            const performDelete = () => {
                if (!itemIdToDelete) return;
                scripts = scripts.filter(p => p.id != itemIdToDelete);
                saveData();
                if (itemIdInput.value == itemIdToDelete) {
                     clearEditorForm();
                     showEditor(false);
                }
                renderItemList();
                closeDeleteModal();
            };

            // --- Event Listeners ---
            newItemBtn.addEventListener('click', () => {
                clearEditorForm();
                showEditor(true);
                itemTitleInput.focus();
            });

            itemList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                const itemDiv = e.target.closest('.item');
                if (deleteBtn) {
                    openDeleteModal(deleteBtn.dataset.id);
                } else if (itemDiv) {
                    loadItemIntoForm(itemDiv.dataset.id);
                }
            });

            itemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = itemIdInput.value;
                const title = itemTitleInput.value.trim();
                const content = itemContentInput.value.trim();
                
                if (id) { // Update existing
                    const index = scripts.findIndex(p => p.id == id);
                    if (index > -1) scripts[index] = { ...scripts[index], title, content };
                } else { // Create new
                    const newItem = { id: Date.now(), title, content };
                    scripts.push(newItem);
                    itemIdInput.value = newItem.id;
                }
                saveData();
                renderItemList();
                alert('Đã lưu kịch bản!');
            });


            // Nút chỉnh sửa
            const editItemBtn = document.getElementById('edit-item-btn');
            editItemBtn.addEventListener('click', () => {
                itemTitleInput.readOnly = false;
                itemContentInput.readOnly = false;
                itemTitleInput.focus();
            });

            // Nút copy
            const copyItemBtn = document.getElementById('copy-item-btn');
            copyItemBtn.addEventListener('click', () => {
                const contentToCopy = itemContentInput.value;
                if (!contentToCopy) {
                    alert('Không có nội dung để sao chép.');
                    return;
                }
                navigator.clipboard.writeText(contentToCopy).then(() => {
                    alert('Đã sao chép vào clipboard!');
                }).catch(err => alert('Sao chép thất bại!'));
            });

            // Nút xuất TXT
            const exportTxtBtn = document.getElementById('export-txt-btn');
            exportTxtBtn.addEventListener('click', () => {
                const title = itemTitleInput.value.trim();
                const content = itemContentInput.value.trim();
                if (!title && !content) return alert('Không có nội dung để xuất.');
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${title || 'untitled'}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });

            // Nút xóa tất cả
            const deleteAllBtn = document.getElementById('delete-all-btn');
            deleteAllBtn.addEventListener('click', () => {
                if (confirm('Bạn có chắc chắn muốn xóa tất cả kịch bản không?')) {
                    scripts = [];
                    saveData();
                    clearEditorForm();
                    showEditor(false);
                }
            });

            // Initial Load
            renderItemList();
            showEditor(false);
        });
    </script>
</body>
</html>
